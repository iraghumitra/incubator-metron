<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2017-09-15
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20170915" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Metron &#x2013; Contents</title>
    <link rel="stylesheet" href="../../css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="../../css/site.css" />
    <link rel="stylesheet" href="../../css/print.css" media="print" />

      
    <script type="text/javascript" src="../../js/apache-maven-fluido-1.3.0.min.js"></script>

                          
        
<script type="text/javascript">$( document ).ready( function() { $( '.carousel' ).carousel( { interval: 3500 } ) } );</script>
          
            </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                    <a href="http://metron.apache.org/" id="bannerLeft">
                                                                                                <img src="../../images/metron-logo.png"  alt="Apache Metron" width="148px" height="48px"/>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                              <li class="">
                    <a href="http://www.apache.org" class="externalLink" title="Apache">
        Apache</a>
        </li>
      <li class="divider ">/</li>
            <li class="">
                    <a href="http://metron.apache.org/" class="externalLink" title="Metron">
        Metron</a>
        </li>
      <li class="divider ">/</li>
            <li class="">
                    <a href="../../index.html" title="Documentation">
        Documentation</a>
        </li>
      <li class="divider ">/</li>
        <li class="">Contents</li>
        
                
                    
                  <li id="publishDate" class="pull-right">Last Published: 2017-09-15</li> <li class="divider pull-right">|</li>
              <li id="projectVersion" class="pull-right">Version: 0.4.1</li>
            
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">User Documentation</li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
      <li>
    
                          <a href="../../index.html" title="Metron">
          <i class="icon-chevron-down"></i>
        Metron</a>
                    <ul class="nav nav-list">
                      
      <li>
    
                          <a href="../../Upgrading.html" title="Upgrading">
          <i class="none"></i>
        Upgrading</a>
            </li>
                                                                                                                                                      
      <li>
    
                          <a href="../../metron-analytics/index.html" title="Analytics">
          <i class="icon-chevron-right"></i>
        Analytics</a>
                  </li>
                      
      <li>
    
                          <a href="../../metron-contrib/metron-docker/index.html" title="Docker">
          <i class="none"></i>
        Docker</a>
            </li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                
      <li>
    
                          <a href="../../metron-deployment/index.html" title="Deployment">
          <i class="icon-chevron-right"></i>
        Deployment</a>
                  </li>
                      
      <li>
    
                          <a href="../../metron-interface/metron-alerts/index.html" title="Alerts">
          <i class="none"></i>
        Alerts</a>
            </li>
                      
      <li>
    
                          <a href="../../metron-interface/metron-config/index.html" title="Config">
          <i class="none"></i>
        Config</a>
            </li>
                      
      <li>
    
                          <a href="../../metron-interface/metron-rest/index.html" title="Rest">
          <i class="none"></i>
        Rest</a>
            </li>
                                                                                                                                                                                                                                                                            
      <li>
    
                          <a href="../../metron-platform/index.html" title="Platform">
          <i class="icon-chevron-down"></i>
        Platform</a>
                    <ul class="nav nav-list">
                      
      <li>
    
                          <a href="../../metron-platform/Performance-tuning-guide.html" title="Performance-tuning-guide">
          <i class="none"></i>
        Performance-tuning-guide</a>
            </li>
                      
      <li>
    
                          <a href="../../metron-platform/metron-api/index.html" title="Api">
          <i class="none"></i>
        Api</a>
            </li>
                      
      <li class="active">
    
            <a href="#"><i class="none"></i>Common</a>
          </li>
                      
      <li>
    
                          <a href="../../metron-platform/metron-data-management/index.html" title="Data-management">
          <i class="none"></i>
        Data-management</a>
            </li>
                      
      <li>
    
                          <a href="../../metron-platform/metron-enrichment/index.html" title="Enrichment">
          <i class="none"></i>
        Enrichment</a>
            </li>
                      
      <li>
    
                          <a href="../../metron-platform/metron-indexing/index.html" title="Indexing">
          <i class="none"></i>
        Indexing</a>
            </li>
                      
      <li>
    
                          <a href="../../metron-platform/metron-management/index.html" title="Management">
          <i class="none"></i>
        Management</a>
            </li>
                                                                        
      <li>
    
                          <a href="../../metron-platform/metron-parsers/index.html" title="Parsers">
          <i class="icon-chevron-right"></i>
        Parsers</a>
                  </li>
                      
      <li>
    
                          <a href="../../metron-platform/metron-pcap-backend/index.html" title="Pcap-backend">
          <i class="none"></i>
        Pcap-backend</a>
            </li>
                      
      <li>
    
                          <a href="../../metron-platform/metron-writer/index.html" title="Writer">
          <i class="none"></i>
        Writer</a>
            </li>
              </ul>
        </li>
                                                                                                            
      <li>
    
                          <a href="../../metron-sensors/index.html" title="Sensors">
          <i class="icon-chevron-right"></i>
        Sensors</a>
                  </li>
                                                                        
      <li>
    
                          <a href="../../metron-stellar/stellar-common/index.html" title="Stellar-common">
          <i class="icon-chevron-right"></i>
        Stellar-common</a>
                  </li>
                                                                        
      <li>
    
                          <a href="../../use-cases/index.html" title="Use-cases">
          <i class="icon-chevron-right"></i>
        Use-cases</a>
                  </li>
              </ul>
        </li>
            </ul>
                
                    
                
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="../../images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <h1>Contents</h1>
<p><a name="Contents"></a></p>

<ul>
  
<li><a href="#Stellar_Language">Stellar Language</a></li>
  
<li><a href="#Global_Configuration">Global Configuration</a></li>
  
<li><a href="#Validation_Framework">Validation Framework</a></li>
  
<li><a href="#Management_Utility">Management Utility</a></li>
  
<li><a href="topology-errors/index.html">Topology Errors</a></li>
  
<li><a href="#Performance_Logging">Performance Logging</a></li>
</ul>
<p><a name="Stellar_Language"></a></p>
<h1>Stellar Language</h1>
<p>For a variety of components (threat intelligence triage and field transformations) we have the need to do simple computation and transformation using the data from messages as variables.<br />For those purposes, there exists a simple, scaled down DSL created to do simple computation and transformation.</p>
<p>The query language supports the following:</p>

<ul>
  
<li>Referencing fields in the enriched JSON</li>
  
<li>String literals are quoted with either <tt>'</tt> or <tt>&quot;</tt>, and support escaping for <tt>'</tt>, <tt>&quot;</tt>, <tt>\t</tt>, <tt>\r</tt>, <tt>\n</tt>, and backslash</li>
  
<li>Simple boolean operations: <tt>and</tt>, <tt>not</tt>, <tt>or</tt>
  
<ul>
    
<li>Boolean expressions are short-circuited (e.g. <tt>true or FUNC()</tt> would never execute <tt>FUNC</tt>)</li>
  </ul></li>
  
<li>Simple arithmetic operations: <tt>*</tt>, <tt>/</tt>, <tt>+</tt>, <tt>-</tt> on real numbers or integers</li>
  
<li>Simple comparison operations <tt>&lt;</tt>, <tt>&gt;</tt>, <tt>&lt;=</tt>, <tt>&gt;=</tt></li>
  
<li>Simple equality comparison operations <tt>==</tt>, <tt>!=</tt></li>
  
<li>if/then/else comparisons (i.e. <tt>if var1 &lt; 10 then 'less than 10' else '10 or more'</tt>)</li>
  
<li>Determining whether a field exists (via <tt>exists</tt>)</li>
  
<li>An <tt>in</tt> operator that works like the <tt>in</tt> in Python</li>
  
<li>The ability to have parenthesis to make order of operations explicit</li>
  
<li>User defined functions, including Lambda expressions</li>
</ul>
<p>For documentation of Stellar, please see the <a href="../../metron-stellar/stellar-common/index.html">Stellar README</a>.</p>
<p><a name="Global_Configuration"></a></p>
<h1>Global Configuration</h1>
<p>The format of the global enrichment is a JSON String to Object map. This is intended for configuration which is non sensor specific configuration.</p>
<p>This configuration is stored in zookeeper, but looks something like</p>

<div class="source">
<div class="source">
<pre>{
  &quot;es.clustername&quot;: &quot;metron&quot;,
  &quot;es.ip&quot;: &quot;node1&quot;,
  &quot;es.port&quot;: &quot;9300&quot;,
  &quot;es.date.format&quot;: &quot;yyyy.MM.dd.HH&quot;,
  &quot;parser.error.topic&quot;: &quot;indexing&quot;
  &quot;fieldValidations&quot; : [
              {
                &quot;input&quot; : [ &quot;ip_src_addr&quot;, &quot;ip_dst_addr&quot; ],
                &quot;validation&quot; : &quot;IP&quot;,
                &quot;config&quot; : {
                    &quot;type&quot; : &quot;IPV4&quot;
                           }
              } 
                       ]
}
</pre></div></div>
<p><a name="Validation_Framework"></a></p>
<h1>Validation Framework</h1>
<p>Inside of the global configuration, there is a validation framework in place that enables the validation that messages coming from all parsers are valid. This is done in the form of validation plugins where assertions about fields or whole messages can be made. </p>
<p>The format for this is a <tt>fieldValidations</tt> field inside of global config. This is associated with an array of field validation objects structured like so:</p>

<ul>
  
<li><tt>input</tt> : An array of input fields or a single field. If this is omitted, then the whole messages is passed to the validator.</li>
  
<li><tt>config</tt> : A String to Object map for validation configuration. This is optional if the validation function requires no configuration.</li>
  
<li><tt>validation</tt> : The validation function to be used. This is one of
  
<ul>
    
<li><tt>STELLAR</tt> : Execute a Stellar Language statement. Expects the query string in the <tt>condition</tt> field of the config.</li>
    
<li><tt>IP</tt> : Validates that the input fields are an IP address. By default, if no configuration is set, it assumes <tt>IPV4</tt>, but you can specify the type by passing in the config by passing in <tt>type</tt> with either <tt>IPV6</tt> or <tt>IPV4</tt> or by passing in a list [<tt>IPV4</tt>,<tt>IPV6</tt>] in which case the input(s) will be validated against both.</li>
    
<li><tt>DOMAIN</tt> : Validates that the fields are all domains.</li>
    
<li><tt>EMAIL</tt> : Validates that the fields are all email addresses</li>
    
<li><tt>URL</tt> : Validates that the fields are all URLs</li>
    
<li><tt>DATE</tt> : Validates that the fields are a date. Expects <tt>format</tt> in the config.</li>
    
<li><tt>INTEGER</tt> : Validates that the fields are an integer. String representation of an integer is allowed.</li>
    
<li><tt>REGEX_MATCH</tt> : Validates that the fields match a regex. Expects <tt>pattern</tt> in the config.</li>
    
<li><tt>NOT_EMPTY</tt> : Validates that the fields exist and are not empty (after trimming.)</li>
  </ul></li>
</ul>
<p><a name="Management_Utility"></a></p>
<h1>Management Utility</h1>
<p>Configurations should be stored on disk in the following structure starting at <tt>$BASE_DIR</tt>:</p>

<ul>
  
<li>global.json : The global config</li>
  
<li><tt>sensors</tt> : The subdirectory containing sensor enrichment configuration JSON (e.g. <tt>snort.json</tt>, <tt>bro.json</tt>)</li>
</ul>
<p>By default, this directory as deployed by the ansible infrastructure is at <tt>$METRON_HOME/config/zookeeper</tt></p>
<p>While the configs are stored on disk, they must be loaded into Zookeeper to be used. To this end, there is a utility program to assist in this called <tt>$METRON_HOME/bin/zk_load_config.sh</tt></p>
<p>This has the following options:</p>

<div class="source">
<div class="source">
<pre> -f,--force                                Force operation
 -h,--help                                 Generate Help screen
 -i,--input_dir &lt;DIR&gt;                      The input directory containing
                                           the configuration files named
                                           like &quot;$source.json&quot;
 -m,--mode &lt;MODE&gt;                          The mode of operation: DUMP,
                                           PULL, PUSH
 -o,--output_dir &lt;DIR&gt;                     The output directory which will
                                           store the JSON configuration
                                           from Zookeeper
 -z,--zk_quorum &lt;host:port,[host:port]*&gt;   Zookeeper Quorum URL
                                           (zk1:port,zk2:port,...)
</pre></div></div>
<p>Usage examples:</p>

<ul>
  
<li>To dump the existing configs from zookeeper on the singlenode vagrant machine: <tt>$METRON_HOME/bin/zk_load_configs.sh -z node1:2181 -m DUMP</tt></li>
  
<li>To push the configs into zookeeper on the singlenode vagrant machine: <tt>$METRON_HOME/bin/zk_load_configs.sh -z node1:2181 -m PUSH -i $METRON_HOME/config/zookeeper</tt></li>
  
<li>To pull the configs from zookeeper to the singlenode vagrant machine disk: <tt>$METRON_HOME/bin/zk_load_configs.sh -z node1:2181 -m PULL -o $METRON_HOME/config/zookeeper -f</tt></li>
</ul>
<p><a name="Topology_Errors"></a></p>
<h1>Topology Errors</h1>
<p>Errors generated in Metron topologies are transformed into JSON format and follow this structure:</p>

<div class="source">
<div class="source">
<pre>{
  &quot;exception&quot;: &quot;java.lang.IllegalStateException: Unable to parse Message: ...&quot;,
  &quot;failed_sensor_type&quot;: &quot;bro&quot;,
  &quot;stack&quot;: &quot;java.lang.IllegalStateException: Unable to parse Message: ...&quot;,
  &quot;hostname&quot;: &quot;node1&quot;,
  &quot;source:type&quot;: &quot;error&quot;,
  &quot;raw_message&quot;: &quot;{\&quot;http\&quot;: {\&quot;ts\&quot;:1488809627.000000.31915,\&quot;uid\&quot;:\&quot;C9JpSd2vFAWo3mXKz1\&quot;, ...&quot;,
  &quot;error_hash&quot;: &quot;f7baf053f2d3c801a01d196f40f3468e87eea81788b2567423030100865c5061&quot;,
  &quot;error_type&quot;: &quot;parser_error&quot;,
  &quot;message&quot;: &quot;Unable to parse Message: {\&quot;http\&quot;: {\&quot;ts\&quot;:1488809627.000000.31915,\&quot;uid\&quot;:\&quot;C9JpSd2vFAWo3mXKz1\&quot;, ...&quot;,
  &quot;timestamp&quot;: 1488809630698
}
</pre></div></div>
<p>Each topology can be configured to send error messages to a specific Kafka topic. The parser topologies retrieve this setting from the the <tt>parser.error.topic</tt> setting in the global config:</p>

<div class="source">
<div class="source">
<pre>{
  &quot;es.clustername&quot;: &quot;metron&quot;,
  &quot;es.ip&quot;: &quot;node1&quot;,
  &quot;es.port&quot;: &quot;9300&quot;,
  &quot;es.date.format&quot;: &quot;yyyy.MM.dd.HH&quot;,
  &quot;parser.error.topic&quot;: &quot;indexing&quot;
}
</pre></div></div>
<p>Error topics for enrichment and threat intel errors are passed into the enrichment topology as flux properties named <tt>enrichment.error.topic</tt> and <tt>threat.intel.error.topic</tt>. These properties can be found in <tt>$METRON_HOME/config/enrichment.properties</tt>.</p>
<p>The error topic for indexing errors is passed into the indexing topology as a flux property named <tt>index.error.topic</tt>. This property can be found in either <tt>$METRON_HOME/config/elasticsearch.properties</tt> or <tt>$METRON_HOME/config/solr.properties</tt> depending on the search engine selected.</p>
<p>By default all error messages are sent to the <tt>indexing</tt> topic so that they are indexed and archived, just like other messages. The indexing config for error messages can be found at <tt>$METRON_HOME/config/zookeeper/indexing/error.json</tt>.</p>
<p><a name="Performance_Logging"></a></p>
<h1>Performance Logging</h1>
<p>The PerformanceLogger class provides functionality that enables developers to debug performance issues. Basic usage looks like the following:</p>

<div class="source">
<div class="source">
<pre>// create a simple inner performance class to use for logger instantiation
public static class Perf {}
// instantiation
PerformnanceLogger perfLog = new PerformanceLogger(() -&gt; getConfigurations().getGlobalConfig(), Perf.class.getName());
// marking a start time
perfLog.mark(&quot;mark1&quot;);
// ...do some high performance stuff...
// log the elapsed time
perfLog.log(&quot;mark1&quot;, &quot;My high performance stuff is very performant&quot;);
// log no additional message, just the basics
perfLog.log(&quot;mark1&quot;);
</pre></div></div>
<p>The logger maintains a Map&lt;String, Long&gt; of named markers that correspond to start times. Calling mark() performs a put on the underlying timing store. Output includes the mark name, elapsed time in nanoseconds, as well as any custom messaging you provide. A sample log would look like the following:</p>

<div class="source">
<div class="source">
<pre>[DEBUG] markName=execute,time(ns)=121411,message=key=7a8dbe44-4cb9-4db2-9d04-7632f543b56c, elapsed time to run execute
</pre></div></div>
<p><b>Configuration</b></p>
<p>The first argument to the logger is a java.util.function.Supplier&lt;Map&lt;String, Object&gt;&gt;. The offers flexibility in being able to provide multiple configuration &#x201c;suppliers&#x201d; depending on your individual usage requirements. The example above, taken from org.apache.metron.enrichment.bolt.GenericEnrichmentBolt, leverages the global config to dymanically provide configuration from Zookeeper. Any updates to the global config via Zookeeper are reflected live at runtime. Currently, the PerformanceLogger supports the following options:</p>

<table border="0" class="table table-striped">
  <thead>
    
<tr class="a">
      
<th>Property Name </th>
      
<th>Type </th>
      
<th>Valid Values </th>
    </tr>
  </thead>
  <tbody>
    
<tr class="b">
      
<td>performance.logging.percent.records </td>
      
<td>Integer </td>
      
<td>0-100 </td>
    </tr>
  </tbody>
</table>
<p><b>Other Usage Details</b></p>
<p>You can also provide your own format String and provide arguments that will be used when formatting that String. This code avoids expensive String concatenation by only formatting when debugging is enabled. For more complex arguments, e.g. JSON serialization, we expose an isDebugEnabled() method.</p>

<div class="source">
<div class="source">
<pre>// log with format String and single argument
perfLog.log(&quot;join-message&quot;, &quot;key={}, elapsed time to join messages&quot;, key);

// check if debugging is enabled for the performance logger to avoid more expensive operations
if (perfLog.isDebugEnabled()) {
    perfLog.log(&quot;join-message&quot;, &quot;key={}, elapsed time to join messages, message={}&quot;, key, rawMessage.toJSONString());
}
</pre></div></div>
<p><b>Side Effects</b></p>
<p>Calling the mark() method multiple times simply resets the start time to the current nano time. Calling log() with a non-existent mark name will log 0 ns elapsed time with a warning indicating that log has been invoked for a mark name that does not exist. The class is not thread-safe and makes no attempt at keeping multiple threads from modifying the same markers.</p>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                    2017
                        <a href="https://www.apache.org">The Apache Software Foundation</a>.
            All Rights Reserved.      
                    
      </div>

                          
        
                </div>
    </footer>
  </body>
</html>
